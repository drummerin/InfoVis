<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <style>

        #states path {
            fill: #ccc;
            stroke: #fff;
        }

        path.arc {
            pointer-events: none;
            fill: none;
            stroke: #000;
            display: none;
        }

        path.cell {
            fill: none;
            pointer-events: all;
        }

        circle {
            fill: steelblue;
            fill-opacity: .8;
            stroke: #fff;
        }

        #cells.voronoi path.cell {
            stroke: brown;
        }

        #cells g:hover path.arc {
            display: inherit;
        }
    </style>
</head>
<body>

<div id="mapi" style="border:1px dotted blue; width: 200px; height: 475px; position: absolute; right: 10px;"></div>
<!--div id="container1" style="border:1px dotted blue; width: 700px; height: 475px; position: relative;"></div-->
<script src="/components/d3/d3.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>


<script>

    var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = (window.innerWidth - 250) - margin.left - margin.right,
        height = (window.innerHeight -50)  - margin.top - margin.bottom;

    var defaultZoom = 1;
    var defaultTranslateX = 0;
    var defaultTranslateY = 0;

    var projection = d3.geoNaturalEarth();
        //.scale(200);

    var path = d3.geo.path()
        .projection(projection);

    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var states = svg.append("svg:g")
        .attr("id", "states") ;

    var circles = svg.append("svg:g")
        .attr("id", "circles");

    var cells = svg.append("svg:g")
        .attr("id", "cells");

    var g = svg.append("g");


    d3.select("input[type=checkbox]").on("change", function() {
        cells.classed("voronoi", this.checked);
    });


    d3.json("countries.geo.json", function(collection) {
        states.selectAll("path")
            .attr("id", "states")
            .data(collection.features)
            .enter().append("svg:path")
            .attr("d", path)
            .on("click", clicked);
    });


    // --------------- Zoom & Pan functionality -----------------------------

    var zoom = d3.behavior.zoom()
        .translate([defaultTranslateX, defaultTranslateY])
        .scale(defaultZoom)
        .scaleExtent([defaultZoom, 100])
        .on("zoom", zoomed);

    d3.select("body")
        .call(zoom);

    function zoomed() {
        console.log("zoooming");
        svg.transition()
            .duration(750)
            .attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")")
            ;
    }

    // --------------------- Click functionality -----------------------------

    function clicked(d) {
        // ... add click functionality!
        d3.select(this).classed("selected", true)
            .style("fill", "red");
        console.log("clicking?");
        console.log(d);
    }


    // ----------------------------- DATA (still airport)-----------------------------------------

    d3.csv("flights-airport.csv", function(flights) {
        var linksByOrigin = {},
            countByAirport = {},
            locationByAirport = {},
            positions = [];

        var arc = d3.geo.greatArc()
            .source(function(d) { return locationByAirport[d.source]; })
            .target(function(d) { return locationByAirport[d.target]; });

        flights.forEach(function(flight) {
            var origin = flight.origin,
                destination = flight.destination,
                links = linksByOrigin[origin] || (linksByOrigin[origin] = []);
            links.push({source: origin, target: destination});
            countByAirport[origin] = (countByAirport[origin] || 0) + 1;
            countByAirport[destination] = (countByAirport[destination] || 0) + 1;
        });

        d3.csv("airports.csv", function(airports) {

            // Only consider airports with at least one flight.
            airports = airports.filter(function(airport) {
                if (countByAirport[airport.iata]) {
                    var location = [+airport.longitude, +airport.latitude];
                    locationByAirport[airport.iata] = location;
                    positions.push(projection(location));
                    return true;
                }
            });

            // Compute the Voronoi diagram of airports' projected positions.
            var polygons = d3.geom.voronoi(positions);

            var g = cells.selectAll("g")
                .data(airports)
                .enter().append("svg:path");

            g.append("svg:path")
                .attr("class", "cell")
                .attr("d", function(d, i) { return "M" + polygons[i].join("L") + "Z"; })
                .on("mouseover", function(d, i) { d3.select("h2 span").text(d.name); });

            g.selectAll("path.arc")
                .data(function(d) { return linksByOrigin[d.iata] || []; })
                .enter().append("svg:path")
                .attr("class", "arc")
                .attr("d", function(d) { return path(arc(d)); });

            circles.selectAll("circle")
                .data(airports)
                .enter().append("svg:circle")
                .attr("cx", function(d, i) { return positions[i][0]; })
                .attr("cy", function(d, i) { return positions[i][1]; })
                .attr("r", function(d, i) { return Math.sqrt(countByAirport[d.iata]); })
                .sort(function(a, b) { return countByAirport[b.iata] - countByAirport[a.iata]; });
        });
    });

</script>
</body>