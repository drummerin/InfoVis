<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <style>

        #states path {
            fill: #ccc;
            stroke: #fff;
        }

        path.arc {
            pointer-events: none;
            fill: none;
            stroke: #000;
            display: none;
        }

        path.cell {
            fill: none;
            pointer-events: all;
        }

        circle {
            fill: steelblue;
            fill-opacity: .8;
            stroke: #fff;
        }

        #cells.voronoi path.cell {
            stroke: brown;
        }

        #cells g:hover path.arc {
            display: inherit;
        }
    </style>
</head>
<body>

<div id="mapi" style="border:1px dotted blue; width: 200px; height: 475px; position: absolute; right: 10px;"></div>
<!--div id="container1" style="border:1px dotted blue; width: 700px; height: 475px; position: relative;"></div-->
<script src="/components/d3/d3.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>


<script>

    var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = (window.innerWidth - 250) - margin.left - margin.right,
        height = (window.innerHeight -50)  - margin.top - margin.bottom;

    var defaultZoom = 1;
    var defaultTranslateX = 0;
    var defaultTranslateY = 0;

    var projection = d3.geoNaturalEarth();
        //.scale(200);

    var path = d3.geo.path()
        .projection(projection);

    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var states = svg.append("svg:g")
        .attr("id", "states") ;

    var circles = svg.append("svg:g")
        .attr("id", "circles");

    var cells = svg.append("svg:g")
        .attr("id", "cells");

    // Group for the arcs
    var arcs = svg.append("g")
        .attr("class","arcs");


    var g = svg.append("g");


    /*d3.select("input[type=checkbox]").on("change", function() {
        cells.classed("voronoi", this.checked);
    });*/


    d3.json("data/countries.geo.json", function(collection) {
        states.selectAll("path")
            .attr("id", "states")
            .data(collection.features)
            .enter().append("svg:path")
            .attr("d", path)
            .on("click", clicked);
    });


    function clicked(d) {
        // ... add click functionality!


        var selection = d3.select(this).style("fill", "black");
        selection.classed("selected", !selection.classed("selected"));

        if (selection.classed("selected")==false) {
            selection.style("fill", "LightGray");
            console.log("WHITE");
        }
        console.log("clicking?");

        var centerPoint = getCenter(d);
        console.log(centerPoint);


        d3.csv("/data/ForestData.csv", function (countries){
            countries.forEach(function (country) {
                var cName = country.Country,
                    startArea= country.y1990,
                    endArea = country.y2016;

                if (d.properties.name==cName)
                {
                    var circle = d3.geoCircle().center([centerPoint.coordinates[0],centerPoint[1]]).radius(2);
                    svg.append("path")
                        .attr("d", path(circle()))
                        .attr("fill","steelblue");
                }


            });


        });

    }


    var margin = {top: 20, right: 20, bottom: 70, left: 40},
        width = 500 - margin.left - margin.right,
        height = 300 - margin.top - margin.bottom;


    var x = d3.scale.ordinal().rangeRoundBands([0, width], .05);

    var y = d3.scale.linear().range([height, 0]);

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom")

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .ticks(10);

    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    d3.csv("/data/ForestDataSmall.csv", function(error, data) {


            data.forEach(function (d) {
                    d.y1990 = +d.y1990;
            });

            x.domain(data.map(function (d) {
                    return d.Country;
            }));
            y.domain([0, d3.max(data, function (d) {
                return d.y1990;

            })]);

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis)
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", "-.6em")
                .attr("transform", "rotate(-90)");

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".8em")
                .style("text-anchor", "end")
                .text("sq km");

        svg.selectAll("bar")
            .data(data)
            .enter().append("rect")
            .style("fill", "red")
            .attr("x", function(d) {  return x(d.Country); })
            .attr("width", x.rangeBand())
            .attr("y", function(d) { return y(d.y1990); })
            .attr("height", function(d) {return height - y(d.y1990); });

        }); 



    // --------------- Zoom & Pan functionality -----------------------------

    var zoom = d3.behavior.zoom()
        .translate([defaultTranslateX, defaultTranslateY])
        .scale(defaultZoom)
        .scaleExtent([defaultZoom, 100])
        .on("zoom", zoomed);

    d3.select("body")
        .call(zoom);

    function zoomed() {
        svg.transition()
            .duration(750)
            .attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")")
            ;
    }

    // --------------------- Click functionality -----------------------------







    // ----------------------------- Center of Country -----------------------------------------

    function getCenter(polygon) {
        if ('geometry' in polygon) polygon = polygon.geometry
        if (!Array.isArray(polygon)) polygon = polygon.coordinates[0]

        var minx = miny = 1000
            ,   maxx = maxy = -1000
        for (var i = 0; i < polygon.length; i++) {
            var point = polygon[i]
            var x = point[0]
            var y = point[1]

            if (x < minx) minx = x
            else if (x > maxx) maxx = x
            if (y < miny) miny = y
            else if (y > maxy) maxy = y
        }

        return {
            type: 'Point',
            coordinates: [
                minx + ((maxx - minx) / 2),
                miny + ((maxy - miny) / 2)
            ]
        }
    }

    // ----------------------------- Center of Country -----------------------------------------




</script>
</body>